<!doctype html>
<html lang="tr" data-theme="auto">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Se√ßim G√∂rselle≈ütirici Pro</title>
  <style>
    :root {
      --bg: #f0f2f5;
      --card: #ffffff;
      --muted: #64748b;
      --accent: #0f172a;
      --primary: #2563eb;
      --border: #e2e8f0;
      --shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
      --hover-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.15), 0 10px 10px -5px rgb(0 0 0 / 0.1);
      --svg-bg: #ffffff;
    }

    [data-theme="dark"] {
      --bg: #0f172a;
      --card: #1e293b;
      --muted: #94a3b8;
      --accent: #f8fafc;
      --border: #334155;
      --shadow: 0 10px 15px -3px rgb(0 0 0 / 0.5);
      --hover-shadow: 0 25px 30px -5px rgb(0 0 0 / 0.6);
      --svg-bg: #1e293b;
    }

    @media (prefers-color-scheme: dark) {
      [data-theme="auto"] {
        --bg: #0f172a; --card: #1e293b; --muted: #94a3b8; --accent: #f8fafc;
        --border: #334155; --svg-bg: #1e293b;
      }
    }

    @font-face {
      font-family: 'ProductSans';
      src: url('ProductSans-Bold.ttf') format('truetype');
      font-weight: 700;
    }
    body {
      margin: 0; background: var(--bg); color: var(--accent);
      font-family: 'ProductSans', -apple-system, sans-serif;
      -webkit-font-smoothing: antialiased;
      transition: background 0.3s, color 0.3s;
    }

    /* Tema Butonu (Saƒü √úst) */
    .theme-zone { position: fixed; top: 20px; right: 20px; z-index: 5000; }
    .theme-btn {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 12px; cursor: pointer; padding: 0;
      display: flex; align-items: center; justify-content: center;
      box-shadow: var(--shadow); width: 44px; height: 44px; font-size: 20px;
    }
    .theme-menu {
      position: absolute; top: 50px; right: 0; background: var(--card);
      border: 1px solid var(--border); border-radius: 12px; display: none;
      box-shadow: var(--shadow); overflow: hidden; min-width: 150px;
    }
    .theme-menu button {
      width: 100%; padding: 12px; border: none; background: none;
      color: var(--accent); font-family: inherit; cursor: pointer;
      text-align: left; transition: background 0.2s; display: flex; align-items: center; gap: 10px;
    }
    .theme-menu button:hover { background: rgba(0,0,0,0.1); }

    /* YENƒ∞: Filtre Butonu ve Men√ºs√º (Sol √úst) */
    .filter-zone { position: fixed; top: 20px; left: 20px; z-index: 5000; }
    .filter-btn {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 12px; cursor: pointer; padding: 0;
      display: flex; align-items: center; justify-content: center;
      box-shadow: var(--shadow); width: 44px; height: 44px; font-size: 20px;
    }
    .filter-menu {
      position: absolute; top: 50px; left: 0; background: var(--card);
      border: 1px solid var(--border); border-radius: 12px; display: none;
      box-shadow: var(--shadow); overflow-y: auto; max-height: 80vh; min-width: 280px;
    }
    .filter-item {
      padding: 12px 16px; border-bottom: 1px solid var(--border); cursor: pointer;
      display: flex; justify-content: space-between; align-items: center;
      transition: background 0.2s; font-size: 14px; color: var(--accent);
    }
    .filter-item:hover { background: rgba(0,0,0,0.05); }
    .filter-item.active { background: var(--primary); color: white; border-color: transparent; }
    .filter-item.active .filter-party-rate { color: rgba(255,255,255,0.8); }
    .filter-item:last-child { border-bottom: none; }
    .filter-party-name { font-weight: bold; }
    .filter-party-rate { font-size: 13px; color: var(--muted); font-weight: 500; }

    /* T√ºrkiye Geneli Bar */
    .overall-stats {
      background: var(--card); padding: 30px; border-radius: 28px; margin-bottom: 35px;
      box-shadow: var(--shadow); border: 1px solid var(--border);
    }
    .overall-title { font-size: 20px; margin-bottom: 20px; font-weight: bold; letter-spacing: -0.2px; }
    .overall-bar {
      display: flex; height: 60px; border-radius: 16px; overflow: visible; background: var(--border);
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); position: relative;
    }
    .overall-segment {
      height: 100%; position: relative; cursor: pointer;
      display: flex; align-items: center; justify-content: center; color: white;
      font-size: 13px; font-weight: bold; overflow: visible;
      min-width: 15px; 
    }

    .overall-segment .tooltip {
      position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(10px);
      background: #1e293b; color: white; padding: 18px 24px; border-radius: 18px;
      font-size: 15px; white-space: nowrap; visibility: hidden; opacity: 0;
      transition: all 0.2s ease-out; pointer-events: none;
      box-shadow: 0 25px 50px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.15);
      z-index: 1000; line-height: 1.6; letter-spacing: 0.3px;
    }
    .overall-segment .tooltip strong { font-weight: 700; }
    .overall-segment .tooltip::after {
      content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%);
      border: 10px solid transparent; border-top-color: #1e293b;
    }
    .overall-segment:hover .tooltip { visibility: visible; opacity: 1; transform: translateX(-50%) translateY(0); }

    /* Kart Tasarƒ±mƒ± */
    .container { max-width: 1440px; margin: 0 auto; padding: 30px 24px; }
    #previews { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 24px; }
    
    .card { 
      background: var(--card); border-radius: 26px; padding: 26px; 
      box-shadow: var(--shadow); border: 1px solid transparent; 
      border-left: 10px solid transparent; cursor: pointer; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
    }
    .card:hover { transform: translateY(-8px); border-color: var(--border); box-shadow: var(--hover-shadow); }
    
    .city-info { display: flex; flex-direction: column; gap: 12px; margin-bottom: 22px; }
    .city-name { font-size: 26px; margin: 0; line-height: 1; letter-spacing: -0.5px; }
    
    .winner-badge { 
      font-size: 11px; font-weight: bold; color: white; 
      padding: 7px 16px; border-radius: 50px; text-transform: uppercase; 
      letter-spacing: 0.8px; width: fit-content; 
    }

    .mini-results { display: flex; flex-direction: column; gap: 12px; }
    .mini-row { display: flex; align-items: center; gap: 12px; font-size: 14px; transition: opacity 0.2s; }
    .mini-row.no-seat { opacity: 0.45; }
    .mini-label { width: 90px; font-weight: 700; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .mini-bar-bg { flex: 1; height: 10px; background: var(--border); border-radius: 10px; }
    .mini-bar-fill { height: 100%; border-radius: 10px; }
    .mini-mv { width: 45px; font-weight: 800; text-align: right; }

    /* Tam Ekran G√∂r√ºn√ºm√º */
    #fsOverlay {
      display:none; position:fixed; inset:0; background:var(--bg); z-index:4000;
      flex-direction:column; align-items:center;
    }
    .fs-window-bar {
      width: 100%; height: 85px; background: var(--card); border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between; padding: 0 40px; 
      box-sizing: border-box; flex-shrink: 0;
    }
    .fs-window-title { display: flex; align-items: center; gap: 25px; }
    .fs-city-title { font-size: 34px; font-weight: bold; margin: 0; color: var(--accent); letter-spacing: -1px; }
    .fs-color-accent { width: 100%; height: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.15); }

    .btn { padding: 12px 28px; border-radius: 12px; border: none; cursor: pointer; font-family: inherit; font-weight: bold; }
    .btn-red { background: #ef4444; color: white; }
    
    #fsInner { flex: 1; width: 100%; display: flex; align-items: center; justify-content: center; padding: 40px; overflow: hidden; }
    #fsInner svg { max-height: 100%; max-width: 95%; height: auto; background: var(--svg-bg); border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.15); }

    .nav-zone { position: fixed; top: 85px; bottom: 0; width: 8%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 70px; color: var(--muted); transition: 0.2s; user-select: none; z-index: 4050; }
    .nav-zone:hover { color: var(--accent); background: rgba(0,0,0,0.03); }

    /* Kontroller */
    header { margin-bottom: 30px; }
    .header-main { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 20px; margin-bottom: 25px; }
    .search-box { padding: 14px 24px; border-radius: 16px; border: 1px solid var(--border); width: 340px; font-family: inherit; font-size: 15px; outline: none; box-shadow: var(--shadow); background: var(--card); color: var(--accent); }
    .controls-wrapper { display:flex; gap:12px; flex-wrap:wrap; align-items:center; background:var(--card); padding:18px; border-radius:22px; border:1px solid var(--border); }
    .btn-primary { background: var(--primary); color: white; }
    .btn-dark { background: var(--card); color: var(--accent); border: 1px solid var(--border); }
    select { padding: 12px; border-radius: 12px; border: 1px solid var(--border); font-family: inherit; background: var(--card); color: var(--accent); }
  </style>
</head>
<body>

<div class="theme-zone">
  <button class="theme-btn" id="themeMainBtn">
    <span id="themeIcon">‚öôÔ∏è</span>
  </button>
  <div class="theme-menu" id="themeMenu">
    <button onclick="changeTheme('light', '‚òÄÔ∏è')">‚òÄÔ∏è A√ßƒ±k Tema</button>
    <button onclick="changeTheme('dark', 'üåô')">üåô Koyu Tema</button>
    <button onclick="changeTheme('auto', '‚öôÔ∏è')">‚öôÔ∏è Otomatik</button>
  </div>
</div>

<div class="filter-zone">
  <button class="filter-btn" id="filterMainBtn" title="Partiye G√∂re Sƒ±rala">
    <span>üìä</span>
  </button>
  <div class="filter-menu" id="filterMenu">
    <div style="padding:15px; text-align:center; color:var(--muted)">Veri bekleniyor...</div>
  </div>
</div>

<div id="fsOverlay">
  <div class="fs-window-bar">
    <div class="fs-window-title">
      <h2 id="fsCityName" class="fs-city-title">---</h2>
      <div id="fsWinnerBadge" class="winner-badge" style="font-size: 15px; padding: 10px 22px;">---</div>
    </div>
    <button class="btn btn-red" id="closeBtn">Kapat</button>
  </div>
  <div id="fsLine" class="fs-color-accent"></div>

  <div id="navL" class="nav-zone" style="left:0;">‚Äπ</div>
  <div id="fsInner"></div>
  <div id="navR" class="nav-zone" style="right:0;">‚Ä∫</div>
</div>

<div class="container">
  <header>
    <div class="header-main">
      <div>
        <h1 style="margin:0; font-size:36px; letter-spacing:-1px;">Se√ßim G√∂rselle≈ütirici</h1>
        <p id="cityCount" style="color:var(--muted); margin:5px 0; font-size:16px;">Veri bekleniyor...</p>
      </div>
      <input type="text" id="citySearch" class="search-box" placeholder="Se√ßim √ßevresi ara...">
    </div>
    <div class="overall-stats" id="overallSection" style="display:none;">
      <div class="overall-title">T√ºrkiye Geneli Tahmini Milletvekili Daƒüƒ±lƒ±mƒ±</div>
      <div class="overall-bar" id="overallBar"></div>
    </div>
    <div class="controls-wrapper">
      <input id="fileTxt" type="file" accept=".txt">
      <button id="btnGen" class="btn btn-primary">Dosyayƒ± Analiz Et</button>
      <div style="width: 1px; height: 40px; background: var(--border); margin: 0 10px;"></div>
      <select id="serverFiles">
        <option value="">Ar≈üivden Se√ß...</option>
        <option value="https://raw.githubusercontent.com/TriQue06/result_visualiser/refs/heads/main/ocak2026_3.txt">Ocak 2026 (#3)</option>
        <option value="https://raw.githubusercontent.com/TriQue06/result_visualiser/refs/heads/main/subat2026_1.txt">≈ûubat 2026 (#1)</option>
      </select>
      <button id="btnFetch" class="btn btn-dark">Ar≈üivden Getir</button>
    </div>
  </header>
  <main id="previews"></main>
</div>

<script>
// TEMA Sƒ∞STEMƒ∞
function changeTheme(theme, icon) {
  document.documentElement.setAttribute('data-theme', theme);
  document.getElementById('themeIcon').innerText = icon;
  localStorage.setItem('pref-theme', theme);
  localStorage.setItem('pref-icon', icon);
  document.getElementById('themeMenu').style.display = 'none';
}

document.getElementById('themeMainBtn').onclick = (e) => {
  const menu = document.getElementById('themeMenu');
  menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
  e.stopPropagation();
};

// Filtre Butonu Olayƒ±
document.getElementById('filterMainBtn').onclick = (e) => {
  const menu = document.getElementById('filterMenu');
  menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
  e.stopPropagation();
};

window.onclick = () => {
  document.getElementById('themeMenu').style.display = 'none';
  document.getElementById('filterMenu').style.display = 'none';
};

// Men√ºye tƒ±klanƒ±nca kapanmasƒ±n
document.getElementById('filterMenu').onclick = (e) => e.stopPropagation();

const savedTheme = localStorage.getItem('pref-theme') || 'auto';
const savedIcon = localStorage.getItem('pref-icon') || '‚öôÔ∏è';
changeTheme(savedTheme, savedIcon);

const PARTY_COLORS = {
  'AKP':{base:'#f29118'}, 'CHP':{base:'#e60017'}, 'DEM':{base:'#9c11a6'}, 'YYP':{base:'#006ca6'},
  'YRP':{base:'#1c8c38'}, 'MHP':{base:'#a60042'}, 'ANP':{base:'#0f4599'}, 'HAK':{base:'#d92121'},
  'ANAP':{base:'#ffcc00'}, 'Tƒ∞P':{base:'#e62274'}, 'ƒ∞Yƒ∞':{base:'#39b8e6'}, 'TKP':{base:'#bf131c'},
  'BBP':{base:'#e64500'}, 'ZP':{base:'#404040'}, 'H√úDA':{base:'#86bf0a'}, 'HKP':{base:'#f25524'},
  'SP':{base:'#bf6a4d'}, 'SP1':{base:'#bf6a4d'}, 'DEVA':{base:'#0064a6'}, 'DEVA1':{base:'#0064a6'}, 'GP':{base:'#0b734b'}, 'GP1':{base:'#0b734b'}, 'SOL':{base:'#006bb3'},
  'MP':{base:'#115ba6'}, 'DP':{base:'#e61789'}, 'GEN√á':{base:'#f2499d'}, 'AP':{base:'#401380'}, 'DEFAULT':{base:'#cccccc'}
};

const PARTY_LABELS = {
  'AKP': 'AK Parti', 'CHP': 'CHP', 'MHP': 'MHP', 'ƒ∞Yƒ∞': 'ƒ∞Yƒ∞ Parti', 'BBP': 'B√ºy√ºk Birlik',
  'H√úDA': 'H√úDA PAR', 'DSP': 'DSP', 'DEM': 'DEM Parti', 'EMEP': 'EMEP', 'Tƒ∞P': 'Tƒ∞P',
  'YRP': 'Yeniden Refah', 'SP': 'Saadet', 'DEVA': 'DEVA Partisi', 'GP': 'Gelecek Partisi',
  'YYP': 'Yeni Yol', 'SP1': 'Saadet', 'DEVA1': 'DEVA Partisi', 'GP1': 'Gelecek Partisi',
  'ANP': 'A Parti', 'ZP': 'Zafer Partisi', 'BTP': 'BTP', 'TKP': 'TKP', 'SOL': 'SOL Parti',
  'TKH': 'TKH', 'AP': 'AP', 'GEN√á': 'Gen√ß Parti', 'MP': 'Memleket', 'ANAP': 'ANAP',
  'DP': 'DP', 'VP': 'Vatan Partisi', 'Mƒ∞L': 'Millet', 'HAK': 'HAK PAR', 'AB': 'AB Parti',
  'MYP': 'Milli Yol', 'ABP': 'ABP', 'DYP': 'DYP', 'GBP': 'GBP', 'YP': 'YP', 'YTP': 'YTP'
};

function trLower(s) { return s.replace(/ƒ∞/g, 'i').replace(/I/g, 'ƒ±').toLowerCase(); }

let originalData = []; // Orijinal veriyi saklar
let currentData = [];  // ≈ûu an g√∂sterilen (sƒ±ralanmƒ±≈ü olabilir)
let svgs = [];
let currentIdx = 0;
let activeSortParty = null; // ≈ûu an sƒ±ralama yapƒ±lan parti

async function renderDashboard(txt) {
  const data = parseResults(txt); 
  if(!data.length) return;
  
  originalData = data; // Yedeƒüi al
  currentData = data;  // Ba≈ülangƒ±√ßta aynƒ±
  activeSortParty = null; // Sƒ±fƒ±rla
  
  document.getElementById('cityCount').innerText = `${data.length} se√ßim √ßevresi aktif.`;
  
  calculateOverall(data);
  updateFilterMenu(data); // Filtre men√ºs√ºn√º doldur
  renderCards(data); // Kartlarƒ± √ßiz
}

function updateFilterMenu(data) {
  const menu = document.getElementById('filterMenu');
  const totals = {};
  let grandTotal = 0;

  data.forEach(item => {
    Object.entries(item.votes).forEach(([p, v]) => {
      totals[p] = (totals[p] || 0) + v;
      grandTotal += v;
    });
  });

  const sortedParties = Object.entries(totals).sort((a,b) => b[1] - a[1]);

  menu.innerHTML = '';
  sortedParties.forEach(([p, v]) => {
    const rate = ((v / grandTotal) * 100).toFixed(2);
    const label = PARTY_LABELS[p] || p;
    
    const div = document.createElement('div');
    div.className = 'filter-item';
    div.id = 'filter-btn-' + p;
    div.innerHTML = `
      <span class="filter-party-name">${label}</span>
      <span class="filter-party-rate">%${rate}</span>
    `;
    div.onclick = () => toggleSort(p);
    menu.appendChild(div);
  });
}

function toggleSort(pCode) {
  // G√∂rsel durum g√ºncelle
  const items = document.querySelectorAll('.filter-item');
  items.forEach(el => el.classList.remove('active'));

  if (activeSortParty === pCode) {
    // Zaten bu partiye g√∂re sƒ±ralƒ±ysa -> ƒ∞PTAL ET
    activeSortParty = null;
    currentData = [...originalData]; // Orijinal sƒ±raya d√∂n
  } else {
    // Yeni sƒ±ralama uygula
    activeSortParty = pCode;
    const btn = document.getElementById('filter-btn-' + pCode);
    if(btn) btn.classList.add('active');

    // Sƒ±ralama Mantƒ±ƒüƒ±: O partinin y√ºzdesine g√∂re (√áoktan aza)
    currentData = [...originalData].sort((a, b) => {
      const totalA = Object.values(a.votes).reduce((x,y)=>x+y,0) || 1;
      const totalB = Object.values(b.votes).reduce((x,y)=>x+y,0) || 1;
      
      const pctA = (a.votes[pCode] || 0) / totalA;
      const pctB = (b.votes[pCode] || 0) / totalB;
      
      return pctB - pctA; // B√ºy√ºkten k√º√ß√ºƒüe
    });
  }
  
  // Yeniden √ßiz
  renderCards(currentData);
}

async function renderCards(data) {
  svgs = [];
  const previews = document.getElementById('previews');
  previews.innerHTML = '';

  for(let i=0; i<data.length; i++) {
    const item = data[i];
    const totalVotes = Object.values(item.votes).reduce((a,b)=>a+b,0) || 1;
    const sorted = Object.entries(item.votes).sort((a,b)=>b[1]-a[1]).slice(0,5);
    const alloc = dhondt(item.votes, item.seats);
    const winnerCode = sorted[0][0];
    const winnerColor = (PARTY_COLORS[winnerCode] || PARTY_COLORS.DEFAULT).base;
    const winnerLabel = PARTY_LABELS[winnerCode] || winnerCode;
    
    const card = document.createElement('div');
    card.className = 'card';
    card.style.borderLeftColor = winnerColor;
    card.innerHTML = `
      <div class="city-info">
        <h3 class="city-name">${item.city}</h3>
        <div class="winner-badge" style="background:${winnerColor}">${winnerLabel}</div>
      </div>
      <div class="mini-results">
        ${sorted.map(([p,v]) => {
          const pColor = (PARTY_COLORS[p] || PARTY_COLORS.DEFAULT).base;
          const pPct = (v/totalVotes*100).toFixed(1);
          const pMv = alloc[p] || 0;
          return `
            <div class="mini-row ${pMv === 0 ? 'no-seat' : ''}">
              <span class="mini-label">${PARTY_LABELS[p]||p}</span>
              <div class="mini-bar-bg"><div class="mini-bar-fill" style="width:${pPct}%; background:${pColor}"></div></div>
              <span class="mini-pct">%${pPct}</span>
              <span class="mini-mv">${pMv} MV</span>
            </div>
          `;
        }).join('')}
      </div>
    `;
    card.onclick = () => openFullscreen(i);
    previews.appendChild(card);
    svgs.push(await buildSVG(item));
  }
}

function calculateOverall(data) {
  const totals = {};
  let globalSeats = 0;
  data.forEach(item => {
    const alloc = dhondt(item.votes, item.seats);
    Object.entries(alloc).forEach(([p, s]) => {
      totals[p] = (totals[p] || 0) + s;
      globalSeats += s;
    });
  });
  
  const sortedTotals = Object.entries(totals).filter(x => x[1] > 0).sort((a, b) => b[1] - a[1]);
  const bar = document.getElementById('overallBar');
  bar.innerHTML = '';

  sortedTotals.forEach(([p, s]) => {
    const weight = (s / globalSeats);
    const percent = weight * 100;
    const pColor = (PARTY_COLORS[p] || PARTY_COLORS.DEFAULT).base;
    const pLabel = PARTY_LABELS[p] || p;
    
    const segment = document.createElement('div');
    segment.className = 'overall-segment';
    
    const displayWeight = Math.max(s, 8); 
    segment.style.flex = `${displayWeight} 1 0%`; 
    segment.style.background = pColor;
    
    if (percent > 6) segment.innerHTML = `<span>${pLabel}: ${s}</span>`;
    segment.innerHTML += `
      <div class="tooltip">
        <strong style="font-size:18px; display:block; margin-bottom:8px; color:#fff">${pLabel}</strong>
        <div style="display:flex; justify-content:space-between; gap:20px;"><span>Milletvekili Sayƒ±sƒ±:</span> <strong>${s}</strong></div>
        <div style="display:flex; justify-content:space-between; gap:20px; margin-top:6px;"><span>Meclis Payƒ±:</span> <strong>%${percent.toFixed(1)}</strong></div>
      </div>
    `;
    bar.appendChild(segment);
  });
  document.getElementById('overallSection').style.display = 'block';
}

function openFullscreen(idx) {
  currentIdx = idx;
  const item = currentData[idx];
  const sorted = Object.entries(item.votes).sort((a,b)=>b[1]-a[1]);
  const winnerCode = sorted[0][0];
  const winnerColor = (PARTY_COLORS[winnerCode] || PARTY_COLORS.DEFAULT).base;
  document.getElementById('fsCityName').innerText = item.city;
  const badge = document.getElementById('fsWinnerBadge');
  badge.innerText = PARTY_LABELS[winnerCode] || winnerCode;
  badge.style.background = winnerColor;
  document.getElementById('fsLine').style.background = winnerColor;
  document.getElementById('fsInner').innerHTML = svgs[idx];
  document.getElementById('fsOverlay').style.display = 'flex';
  document.body.style.overflow = 'hidden';
  document.querySelector('.theme-zone').style.display = 'none';
  document.querySelector('.filter-zone').style.display = 'none'; // Filtreyi de gizle
}

function closeFullscreen() {
  document.getElementById('fsOverlay').style.display = 'none';
  document.body.style.overflow = '';
  document.querySelector('.theme-zone').style.display = 'block';
  document.querySelector('.filter-zone').style.display = 'block'; // Filtreyi geri getir
}

document.getElementById('closeBtn').onclick = closeFullscreen;
document.getElementById('navL').onclick = (e) => { e.stopPropagation(); if(currentIdx > 0) openFullscreen(currentIdx - 1); };
document.getElementById('navR').onclick = (e) => { e.stopPropagation(); if(currentIdx < svgs.length - 1) openFullscreen(currentIdx + 1); };

document.addEventListener('keydown', (e) => {
  if (document.getElementById('fsOverlay').style.display === 'flex') {
    if (e.key === "ArrowRight") { if(currentIdx < svgs.length - 1) openFullscreen(currentIdx + 1); }
    else if (e.key === "ArrowLeft") { if(currentIdx > 0) openFullscreen(currentIdx - 1); }
    else if (e.key === "Escape") { closeFullscreen(); }
  }
});

function parseNumber(s){ return parseInt(String(s||'0').replace(/\./g,'').replace(/,/g,'').trim()) || 0; }

function parseResults(txt){
  const blocks = txt.split(/\n(?:-+\s*\n|\s*\n){1,}/).filter(Boolean);
  return blocks.map(b => {
    const lines = b.trim().split('\n').map(l=>l.trim());
    let m = lines[0].match(/^(.+?)\s*[-:(]\s*(\d+)/);
    const city = m ? m[1] : lines[0];
    const seats = m ? parseNumber(m[2]) : 1;
    const votes = {};
    lines.slice(1).forEach(l => {
      let vm = l.match(/^(.+?)[\s:‚Äì-]+([\d\.,]+)/);
      if(vm) votes[vm[1].trim()] = parseNumber(vm[2]);
    });
    return {city, seats, votes};
  });
}

function dhondt(votes, seats) {
  const table = [];
  Object.entries(votes).forEach(([p,v]) => { for(let i=1; i<=seats; i++) table.push({p, q:v/i}); });
  table.sort((a,b) => b.q - a.q);
  const res = {};
  table.slice(0,seats).forEach(x => res[x.p] = (res[x.p]||0) + 1);
  return res;
}

async function buildSVG(obj){
  const W=1365, H=768;
  const total = Object.values(obj.votes).reduce((a,b)=>a+b,0)||1;
  const items = Object.entries(obj.votes).sort((a,b)=>b[1]-a[1]).slice(0,9);
  const alloc = dhondt(obj.votes, obj.seats);
  let s = `<svg width="${W}" height="${H}" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">`;
  items.forEach(([p,v], i) => {
    const y = 60 + i*72;
    const w = (v/total) * 850;
    const color = (PARTY_COLORS[p] || PARTY_COLORS.DEFAULT).base;
    s += `<text x="320" y="${y+32}" font-family="ProductSans" font-size="30" text-anchor="end" fill="var(--accent)">${PARTY_LABELS[p]||p}</text>`;
    s += `<rect x="340" y="${y}" width="${w}" height="48" rx="8" fill="${color}" />`;
    s += `<text x="${355+w}" y="${y+32}" font-family="ProductSans" font-size="26" font-weight="bold" fill="var(--accent)">%${(v/total*100).toFixed(2)}</text>`;
    s += `<text x="1300" y="${y+40}" font-family="ProductSans" font-size="52" font-weight="bold" text-anchor="end" fill="var(--accent)">${alloc[p]||0}</text>`;
  });
  return s + `</svg>`;
}

document.getElementById('btnGen').onclick = async () => {
  const f = document.getElementById('fileTxt').files[0];
  if(f) renderDashboard(await f.text());
};

document.getElementById('btnFetch').onclick = async () => {
  const fileName = document.getElementById('serverFiles').value;
  if(!fileName) return;
  try {
    const res = await fetch(fileName);
    renderDashboard(await res.text());
  } catch(e) { alert("Dosya getirilemedi."); }
};

document.getElementById('citySearch').oninput = (e) => {
  const query = trLower(e.target.value);
  document.querySelectorAll('.card').forEach(card => {
    const cityName = trLower(card.querySelector('.city-name').innerText);
    card.style.display = cityName.includes(query) ? 'block' : 'none';
  });
};
</script>
</body>
</html>