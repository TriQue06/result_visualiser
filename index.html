<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Seçim Görselleştirici — v3.1 (Hızlı)</title>
  <style>
    :root{
      --bg:#f2f2f2;
      --card:#ffffff;
      --muted:#666;
      --accent:#111;
    }
    @font-face{
      font-family: 'ProductSans';
      src: url('ProductSans-Bold.ttf') format('truetype');
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }
    html,body{height:100%;margin:0;padding:0}
    body{
      margin:16px;
      background:var(--bg);
      color:var(--accent);
      font-family:'ProductSans', sans-serif;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    header{
      display:flex;
      flex-direction: column;
      gap:16px;
      margin-bottom:20px;
    }
    .header-info{flex:1}
    h1{margin:0;font-size:26px;}
    .note{font-size:13px;color:var(--muted)}
    
    .controls-wrapper {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      background: rgba(0,0,0,0.04);
      padding: 16px;
      border-radius: 12px;
      align-items: center;
    }
    .control-section {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .divider {
      width: 1px;
      height: 30px;
      background: #ccc;
      margin: 0 8px;
    }
    
    input[type=file], select {
      padding:8px;
      border-radius:8px;
      border:1px solid #ccc;
      font-family:'ProductSans';
      background: #fff;
    }
    
    button{
      padding:8px 16px;border-radius:8px;border:0;background:#111;color:#fff;cursor:pointer;
      font-family:'ProductSans';
      transition: background 0.2s;
    }
    button:hover { background: #333; }
    
    main{display:block}
    #previews{display:flex;flex-direction:column;gap:12px}
    
    /* Kart ve Yükleme Stilleri */
    .card{
        background:var(--card);
        border-radius:10px;
        padding:10px;
        box-shadow:0 6px 18px rgba(0,0,0,.08);
        cursor:pointer;
        min-height: 100px;
        transition: opacity 0.3s;
    }
    .card.loading { opacity: 0.6; }
    .card .svg-container {
        overflow: hidden;
        max-height: 320px;
        background: #f9f9f9;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 180px;
    }
    /* Basit bir yükleme animasyonu */
    .spinner {
        width: 30px;
        height: 30px;
        border: 3px solid #eee;
        border-top: 3px solid #111;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .meta strong{font-size:16px;}
    .small{font-size:13px;color:var(--muted)}
    
    #fsOverlay{
      display:none;
      position:fixed;inset:0;background:#fff;z-index:1200;
      align-items:center;justify-content:center;padding:20px;
      overflow:auto;
    }
    #fsContent{max-width:1400px;width:100%;height:100%;display:flex;align-items:center;justify-content:center}
    #fsInner{width:100%;height:100%;display:flex;align-items:center;justify-content:center}
    .nav-zone{
      position:fixed;top:0;bottom:0;width:20%;
      z-index:1250; background:transparent; cursor:pointer;
    }
    #navLeft{left:0}
    #navRight{right:0}
    #backBtn{
      position:fixed;left:8px;top:8px;z-index:1300;
      width:36px;height:28px;border-radius:6px;border:0;background:rgba(0,0,0,0.08);
      display:flex;align-items:center;justify-content:center;font-size:12px;cursor:pointer;
    }
    @media (min-width:1000px){ .card{width:100%} }
    :focus{outline:none}
    :focus-visible{outline:2px solid rgba(0,0,0,0.12)}
  </style>
</head>
<body>
  <div id="backBtn" title="Geri dön">&larr;</div>

  <header>
    <div class="header-info">
      <h1>Seçim Görselleştirici</h1>
      <div class="note">Dosya seçin veya mevcut sonuçlardan birini getirin.</div>
    </div>
    
    <div class="controls-wrapper">
      <div class="control-section">
        <span class="small">Cihazdan:</span>
        <input id="fileTxt" type="file" accept=".txt" />
        <button id="btnGen" type="button">Oluştur</button>
      </div>
      <div class="divider"></div>
      <div class="control-section">
        <span class="small">Sunucudan:</span>
        <select id="serverFiles">
          <option value="">Dosya Seç...</option>
          <option value="ocak2026_3.txt">Ocak 2026 (#3)</option>
          <option value="subat2026_1.txt">Şubat 2026 (#1)</option>
        </select>
        <button id="btnFetch" type="button">Getir</button>
      </div>
    </div>
  </header>

  <main>
    <div id="previews"></div>
  </main>

  <div id="fsOverlay" role="dialog" aria-modal="true">
    <div id="fsContent">
      <div id="fsInner"></div>
    </div>
    <div id="navLeft" class="nav-zone"></div>
    <div id="navRight" class="nav-zone"></div>
  </div>

<script>
const PARTY_COLORS = {
  'AKP':{base:'#f29118',majority:'#f5a746',leading:'#f8c07b'},
  'CHP':{base:'#e60017',majority:'#eb3345',leading:'#f16d7a'},
  'DEM':{base:'#9c11a6',majority:'#b041b8',leading:'#c677cc'},
  'YRP':{base:'#1c8c38'}, 'MHP':{base:'#a60042'}, 'ANP':{base:'#0f4599'},
  'ANAP':{base:'#ffcc00'}, 'TİP':{base:'#e62274'}, 'İYİ':{base:'#39b8e6'},
  'BBP':{base:'#e64500'}, 'GENÇ':{base:'#e64596'}, 'HAK':{base:'#007a99'},
  'MYP':{base:'#4b2e83'}, 'SOL':{base:'#1485cc'}, 'HÜDA':{base:'#00993d'},
  'DSP':{base:'#17cee6'}, 'ZP':{base:'#404040'}, 'BTP':{base:'#bf000a'},
  'SP':{base:'#bf6a4d'}, 'DEVA':{base:'#0064a6'}, 'GP':{base:'#0a6642'},
  'AP':{base:'#401380'}, 'TKP':{base:'#bf131d'}, 'DP':{base:'#e61789'},
  'DEFAULT':{base:'#cccccc'}
};

const PARTY_LABELS = {
  'AKP':'AK Parti','CHP':'CHP','MHP':'MHP','İYİ':'İYİ Parti',
  'YRP':'Yeniden Refah','BBP':'Büyük Birlik','DEM':'DEM Parti','TİP':'TİP','ANP':'A Parti',
  'GENÇ':'Genç Parti','HAK':'HAK PAR','MYP':'Milli Yol','SOL':'SOL Parti','ANAP':'ANAP',
  'TEK':'TEK Parti','AB':'AB Parti','MİL':'Millet','VP':'Vatan Partisi',
  'GP':'Gelecek','SP':'Saadet','ZP':'Zafer Partisi','HÜDA':'HÜDA PAR',
  'DSP':'DSP','BTP':'BTP','DEVA':'DEVA','AP':'AP','TKP':'TKP','MP':'Memleket','DP':'Demokrat Parti'
};

function parseNumber(s){
  if(!s) return 0;
  s = String(s).replace(/\./g,'').replace(/,/g,'').replace(/[^\d\-]/g,'').trim();
  const n = parseInt(s,10);
  return isNaN(n)?0:n;
}

function parseResults(txt){
  const blocks = txt.split(/\n(?:-+\s*\n|\s*\n){1,}/).map(b=>b.trim()).filter(Boolean);
  const out = [];
  for(const b of blocks){
    const lines = b.split(/\n/).map(l=>l.trim()).filter(Boolean);
    if(lines.length === 0) continue;
    let city = null, seats = 0;
    const first = lines[0];
    let m = first.match(/^(.+?)\s*[-:]\s*(\d+)/);
    if(!m) m = first.match(/^(.+?)\s+(\d+)\s*$/);
    if(!m) m = first.match(/^(.+?)\s*\((\d+)\)/);
    if(m){ city = m[1].trim(); seats = parseNumber(m[2]); }
    else { city = first; const mm = lines.slice(1).join(' ').match(/(\d{1,3})/); if(mm) seats = parseNumber(mm[1]); }
    if(!city) continue;
    if(!seats) seats = 1;
    const votes = {};
    for(let i=1;i<lines.length;i++){
      const ln = lines[i];
      let mm = ln.match(/^(.+?)[\s:–-]+([\d\.,]+)/);
      if(!mm) mm = ln.match(/^(.+?)\s+(\d{1,})\b/);
      if(!mm) continue;
      let party = mm[1].trim().replace(/\s+/g,' ');
      const v = parseNumber(mm[2]);
      votes[party] = (votes[party]||0) + v;
    }
    out.push({city,seats,votes});
  }
  return out;
}

function dhondt(votes,seats){
  const filtered = {};
  Object.entries(votes).forEach(([p,v])=>{ if(v>0) filtered[p]=v; });
  const ps = Object.keys(filtered);
  const table = [];
  ps.forEach(p=>{ for(let i=1;i<=seats;i++) table.push({p,q:filtered[p]/i}); });
  table.sort((a,b)=>b.q-a.q);
  const alloc = {};
  ps.forEach(p=>alloc[p]=0);
  table.slice(0,seats).forEach(x=>alloc[x.p]++);
  return alloc;
}

async function fetchSilhouette(city){
  const candidates = [
    `svg/${encodeURIComponent(city)}.svg`,
    `svg/${encodeURIComponent(city.toLowerCase())}.svg`,
    `svg/${encodeURIComponent(city.replace(/\s+/g,'_'))}.svg`
  ];
  for(const url of candidates){
    try{
      const res = await fetch(url);
      if(res.ok) return await res.text();
    }catch(e){}
  }
  return null;
}

let fontBase64Cache = null;
async function loadFontBase64Once(){
  if(fontBase64Cache) return fontBase64Cache;
  try {
    const res = await fetch('ProductSans-Bold.ttf');
    const buf = await res.arrayBuffer();
    let binary = '';
    const bytes = new Uint8Array(buf);
    for(let i=0; i<bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
    fontBase64Cache = btoa(binary);
    return fontBase64Cache;
  } catch(e) { return null; }
}

async function buildSVG(obj){
  const W = 1365, H = 768;
  const totalVotes = Object.values(obj.votes).reduce((a,b)=>a+b,0) || 1;
  const items = Object.entries(obj.votes).filter(([,v])=>v>0).sort((a,b)=>b[1]-a[1]).slice(0,9);
  if(items.length === 0) items.push(['DEFAULT', 0]);

  const alloc = dhondt(obj.votes, obj.seats);
  const leader = items[0][0];
  const col = PARTY_COLORS[leader] || PARTY_COLORS.DEFAULT;
  const silColor = (alloc[leader] > (obj.seats/2)) ? (col.majority||col.base) : (col.leading||col.base);

  const sil = await fetchSilhouette(obj.city);
  let silInner = sil ? sil.replace(/<\s*svg[^>]*>/i,'').replace(/<\/svg\s*>/i,'') : `<circle cx="220" cy="220" r="200" fill="${silColor}" />`;
  if(sil) silInner = `<g fill="${silColor}" stroke="none">${silInner}</g>`;

  const fontB64 = await loadFontBase64Once();
  let fontStyle = fontB64 ? `@font-face{font-family:'ProductSans';src:url(data:font/ttf;base64,${fontB64}) format('truetype');}` : "";

  let s = `<svg width="${W}" height="${H}" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg"><style>${fontStyle} text{font-family:'ProductSans',sans-serif;}</style><rect width="100%" height="100%" fill="#fff"/>`;
  s += `<g transform="translate(40,30) scale(0.8)">${silInner}</g>`;
  s += `<text x="360" y="90" font-size="64" font-weight="700" fill="#111">${escapeXML(obj.city)}</text>`;

  items.forEach(([p, v], i)=>{
    const rowTop = 160 + i * 64; 
    const w = Math.round((v / (items.reduce((a,b)=>a+b[1],0)||totalVotes)) * 700);
    const pct = (v / totalVotes * 100).toFixed(2).replace('.',',');
    const pc = (PARTY_COLORS[p] || PARTY_COLORS.DEFAULT).base;
    s += `<text x="340" y="${rowTop+24}" font-size="32" text-anchor="end" fill="#111" dominant-baseline="middle">${escapeXML(PARTY_LABELS[p]||p)}</text>`;
    s += `<rect x="360" y="${rowTop}" width="${w}" height="48" rx="6" fill="${pc}"/>`;
    s += `<text x="${w < 120 ? 360+w+12 : 360+w-12}" y="${rowTop+24}" font-size="22" fill="${w<120?'#111':'#fff'}" text-anchor="${w<120?'start':'end'}" dominant-baseline="middle">%${pct}</text>`;
    s += `<text x="1120" y="${rowTop+24}" font-size="34" font-weight="700" fill="#111" text-anchor="middle" dominant-baseline="middle">${alloc[p]||0}</text>`;
  });
  return s + `</svg>`;
}

function escapeXML(s){ return String(s||'').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&apos;"})[ch]); }

document.addEventListener('DOMContentLoaded', ()=> {
  const previews = document.getElementById('previews');
  const fsOverlay = document.getElementById('fsOverlay');
  const fsInner = document.getElementById('fsInner');
  const serverSelect = document.getElementById('serverFiles');
  
  let generated = [];
  let currentIndex = -1;

  async function generateFromText(txt) {
    const data = parseResults(txt);
    if(!data.length){ alert('Veri bulunamadı.'); return; }

    previews.innerHTML = ''; 
    generated = new Array(data.length).fill(null);

    data.forEach((c, idx) => {
      const card = document.createElement('div');
      card.className = 'card loading';
      card.id = `card-${idx}`;
      card.innerHTML = `
        <div class="meta"><strong>${c.city}</strong><div class="small">${c.seats} Sandalye</div></div>
        <div class="svg-container" id="svg-cont-${idx}"><div class="spinner"></div></div>
      `;
      card.addEventListener('click', () => { if(generated[idx]) openFullscreen(idx); });
      previews.appendChild(card);
    });

    await loadFontBase64Once();

    for(let i=0; i < data.length; i++) {
        await new Promise(r => setTimeout(r, 10)); 
        
        const svg = await buildSVG(data[i]);
        generated[i] = { city: data[i].city, svg: svg };
        
        const container = document.getElementById(`svg-cont-${i}`);
        const card = document.getElementById(`card-${i}`);
        if(container && card) {
            container.innerHTML = svg;
            card.classList.remove('loading');
        }
    }
  }

  document.getElementById('btnGen').addEventListener('click', async ()=> {
    const f = document.getElementById('fileTxt').files[0];
    if(f) generateFromText(await f.text());
  });

  document.getElementById('btnFetch').addEventListener('click', async () => {
    const fileName = serverSelect.value;
    if(!fileName) return;
    try {
      const res = await fetch(fileName);
      if(!res.ok) throw new Error();
      generateFromText(await res.text());
    } catch(e) { alert('Dosya yüklenemedi.'); }
  });

  function openFullscreen(index){
    if(!generated[index]) return;
    currentIndex = index;
    fsInner.innerHTML = generated[index].svg;
    fsOverlay.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }

  function closeFullscreen(){
    fsOverlay.style.display = 'none';
    document.body.style.overflow = '';
  }

  document.getElementById('navLeft').addEventListener('click', (e)=> { e.stopPropagation(); if(currentIndex > 0) openFullscreen(currentIndex - 1); });
  document.getElementById('navRight').addEventListener('click', (e)=> { e.stopPropagation(); if(currentIndex < generated.length - 1) openFullscreen(currentIndex + 1); });
  fsOverlay.addEventListener('click', (e)=>{ if(e.target === fsOverlay) closeFullscreen(); });
  document.addEventListener('keydown', (e)=>{
    if(fsOverlay.style.display === 'flex'){
      if(e.key === 'ArrowLeft' && currentIndex > 0) openFullscreen(currentIndex - 1);
      else if(e.key === 'ArrowRight' && currentIndex < generated.length - 1) openFullscreen(currentIndex + 1);
      else if(e.key === 'Escape') closeFullscreen();
    }
  });
});
</script>
</body>
</html>