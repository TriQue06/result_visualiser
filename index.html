<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Seçim Görselleştirici</title>
  <style>
    :root {
      --bg: #f0f2f5;
      --card: #ffffff;
      --muted: #64748b;
      --accent: #0f172a;
      --primary: #2563eb;
      --border: #e2e8f0;
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    @font-face {
      font-family: 'ProductSans';
      src: url('ProductSans-Bold.ttf') format('truetype');
      font-weight: 700;
    }
    body {
      margin: 0; background: var(--bg); color: var(--accent);
      font-family: 'ProductSans', -apple-system, sans-serif;
      -webkit-font-smoothing: antialiased;
    }

    .container { max-width: 1440px; margin: 0 auto; padding: 30px 24px; }

    header { margin-bottom: 30px; }
    .header-main { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 20px; margin-bottom: 25px; }
    
    .search-box {
      padding: 12px 20px; border-radius: 14px; border: 1px solid var(--border);
      width: 320px; font-family: inherit; font-size: 15px; outline: none;
      box-shadow: var(--shadow);
    }
    .search-box:focus { border-color: var(--primary); }

    .overall-stats {
      background: #fff; padding: 20px; border-radius: 20px; margin-bottom: 30px;
      box-shadow: var(--shadow); border: 1px solid var(--border);
    }
    .overall-title { font-size: 18px; margin-bottom: 15px; display: flex; justify-content: space-between; font-weight: bold; }
    .overall-bar {
      display: flex; height: 40px; border-radius: 12px; overflow: hidden; background: #eee;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }
    .overall-segment {
      height: 100%; display: flex; align-items: center; justify-content: center;
      color: white; font-size: 12px; font-weight: bold; transition: width 0.6s ease;
      white-space: nowrap; cursor: help;
    }

    #previews { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 24px; }
    .card {
      background: var(--card); border-radius: 24px; padding: 20px;
      box-shadow: var(--shadow); border: 1px solid transparent;
      cursor: pointer; transition: all 0.3s ease; display: flex; flex-direction: column; gap: 12px;
    }
    .card:hover { transform: translateY(-8px); border-color: var(--primary); }
    .card-header { display: flex; justify-content: space-between; align-items: center; }
    .city-name { font-size: 22px; margin: 0; }
    .seat-badge { background: var(--bg); padding: 5px 12px; border-radius: 10px; font-size: 13px; font-weight: bold; }

    .svg-container {
      width: 100%; aspect-ratio: 16/9; background: #f8fafc; border-radius: 16px;
      display: flex; align-items: center; justify-content: center; border: 1px solid #f1f5f9; overflow: hidden;
    }
    .mini-results { display: flex; flex-direction: column; gap: 8px; }
    .mini-row { display: flex; align-items: center; gap: 10px; font-size: 12px; }
    .mini-label { width: 90px; font-weight: 700; color: #334155; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .mini-bar-bg { flex: 1; height: 6px; background: #f1f5f9; border-radius: 10px; }
    .mini-bar-fill { height: 100%; border-radius: 10px; }
    .mini-pct { width: 40px; text-align: right; color: var(--muted); font-weight: 700; }

    /* Fullscreen Overlay */
    #fsOverlay {
      display:none; position:fixed; inset:0; background:rgba(255,255,255,0.99); z-index:2000;
      flex-direction:column; align-items:center; justify-content:center;
    }
    .fs-tools { position: fixed; top: 20px; right: 20px; z-index: 2100; }
    .btn { padding: 12px 24px; border-radius: 12px; border: none; cursor: pointer; font-family: inherit; font-weight: bold; }
    .btn-red { background: #ef4444; color: white; }
    .btn-primary { background: var(--primary); color: white; }

    #fsInner { width: 95vw; height: 85vh; display: flex; align-items: center; justify-content: center; }
    .nav-zone { position: fixed; top: 0; bottom: 0; width: 10%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 60px; color: #cbd5e1; transition: 0.2s; user-select: none; }
    .nav-zone:hover { color: var(--accent); background: rgba(0,0,0,0.02); }
  </style>
</head>
<body>

<div id="fsOverlay">
  <div class="fs-tools">
    <button class="btn btn-red" id="closeBtn">Kapat (ESC)</button>
  </div>
  <div id="navL" class="nav-zone" style="left:0;">‹</div>
  <div id="fsInner"></div>
  <div id="navR" class="nav-zone" style="right:0;">›</div>
</div>

<div class="container">
  <header>
    <div class="header-main">
      <div>
        <h1 style="margin:0; font-size:32px;">Seçim Görselleştirici</h1>
        <p id="cityCount" style="color:var(--muted); margin:5px 0;">Veri bekleniyor...</p>
      </div>
      <div class="search-container">
        <input type="text" id="citySearch" class="search-box" placeholder="Seçim çevresi veya il ara...">
      </div>
    </div>

    <div class="overall-stats" id="overallSection" style="display:none;">
      <div class="overall-title">
        <span>Türkiye Geneli Tahmini Milletvekili Dağılımı</span>
        <span id="totalSeatsLabel"></span>
      </div>
      <div class="overall-bar" id="overallBar"></div>
    </div>

    <div style="display:flex; gap:15px; flex-wrap:wrap; align-items:center;">
      <input id="fileTxt" type="file" accept=".txt">
      <button id="btnGen" class="btn btn-primary">Dosyayı Analiz Et</button>
      <div style="display:flex; gap:8px;">
        <select id="serverFiles" style="padding:10px; border-radius:10px; border:1px solid var(--border);">
          <option value="">Arşivden Seç...</option>
          <option value="ocak2026_3.txt">Ocak 2026 (#3)</option>
          <option value="subat2026_1.txt">Şubat 2026 (#1)</option>
        </select>
        <button id="btnFetch" class="btn btn-dark" style="background:#334155; color:white;">Arşivden Getir</button>
      </div>
    </div>
  </header>

  <main id="previews"></main>
</div>

<script>
const PARTY_COLORS = {

  'AKP':{base:'#f29118',majority:'#f5a746',leading:'#f8c07b'},

  'CHP':{base:'#e60017',majority:'#eb3345',leading:'#f16d7a'},

  'DEM':{base:'#9c11a6',majority:'#b041b8',leading:'#c677cc'},

  'YRP':{base:'#1c8c38'}, 'MHP':{base:'#a60042'}, 'ANP':{base:'#0f4599'},

  'ANAP':{base:'#ffcc00'}, 'TİP':{base:'#e62274'}, 'İYİ':{base:'#39b8e6'},

  'BBP':{base:'#e64500'}, 'GENÇ':{base:'#e64596'}, 'MP':{base:'#115ba6'},

  'MYP':{base:'#4b2e83'}, 'SOL':{base:'#1485cc'}, 'HÜDA':{base:'#00993d'},

  'DSP':{base:'#17cee6'}, 'ZP':{base:'#404040'}, 'BTP':{base:'#bf000a'},

  'SP':{base:'#bf6a4d'}, 'DEVA':{base:'#0064a6'}, 'GP':{base:'#0a6642'},

  'AP':{base:'#401380'}, 'TKP':{base:'#bf131d'}, 'DP':{base:'#e61789'},

  'DEFAULT':{base:'#cccccc'}

};



const PARTY_LABELS = {

  'AKP':'AK Parti','CHP':'CHP','MHP':'MHP','İYİ':'İYİ Parti',

  'YRP':'Yeniden Refah','BBP':'Büyük Birlik','DEM':'DEM Parti','TİP':'TİP','ANP':'A Parti',

  'GENÇ':'Genç Parti','HAK':'HAK PAR','MYP':'Milli Yol','SOL':'SOL Parti','ANAP':'ANAP',

  'TEK':'TEK Parti','AB':'AB Parti','MİL':'Millet','VP':'Vatan Partisi',

  'GP':'Gelecek','SP':'Saadet','ZP':'Zafer Partisi','HÜDA':'HÜDA PAR',

  'DSP':'DSP','BTP':'BTP','DEVA':'DEVA','AP':'AP','TKP':'TKP','MP':'Memleket','DP':'Demokrat Parti'

};
function trLower(s) { return s.replace(/İ/g, 'i').replace(/I/g, 'ı').toLowerCase(); }

let currentData = [];
let svgs = [];
let currentIdx = 0;

async function renderDashboard(txt) {
  const data = parseResults(txt); 
  if(!data.length) return;
  currentData = data;
  svgs = [];
  const previews = document.getElementById('previews');
  previews.innerHTML = '';
  document.getElementById('cityCount').innerText = `${data.length} seçim çevresi yüklendi.`;

  calculateOverall(data);

  for(let i=0; i<data.length; i++) {
    const item = data[i];
    const totalVotes = Object.values(item.votes).reduce((a,b)=>a+b,0) || 1;
    const sorted = Object.entries(item.votes).sort((a,b)=>b[1]-a[1]).slice(0,5);

    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="card-header">
        <h3 class="city-name">${item.city}</h3>
        <span class="seat-badge">${item.seats} MV</span>
      </div>
      <div class="svg-container" id="svg-cont-${i}"></div>
      <div class="mini-results">
        ${sorted.map(([p,v]) => `
          <div class="mini-row">
            <span class="mini-label" title="${PARTY_LABELS[p]||p}">${PARTY_LABELS[p]||p}</span>
            <div class="mini-bar-bg"><div class="mini-bar-fill" style="width:${(v/totalVotes*100)}%; background:${(PARTY_COLORS[p]||PARTY_COLORS.DEFAULT).base}"></div></div>
            <span class="mini-pct">%${(v/totalVotes*100).toFixed(1)}</span>
          </div>
        `).join('')}
      </div>
    `;
    card.onclick = () => openFullscreen(i);
    previews.appendChild(card);

    const svg = await buildSVG(item);
    svgs.push(svg);
    document.getElementById(`svg-cont-${i}`).innerHTML = svg;
  }
}

function calculateOverall(data) {
  const totals = {};
  let globalSeats = 0;
  data.forEach(item => {
    const alloc = dhondt(item.votes, item.seats);
    Object.entries(alloc).forEach(([p, s]) => {
      totals[p] = (totals[p] || 0) + s;
      globalSeats += s;
    });
  });

  const sortedTotals = Object.entries(totals).filter(x => x[1] > 0).sort((a, b) => b[1] - a[1]);
  const bar = document.getElementById('overallBar');
  bar.innerHTML = '';
  
  sortedTotals.forEach(([p, s]) => {
    const segment = document.createElement('div');
    segment.className = 'overall-segment';
    const percent = (s/globalSeats*100);
    segment.style.width = `${percent}%`;
    segment.style.background = (PARTY_COLORS[p] || PARTY_COLORS.DEFAULT).base;
    if (percent > 8) segment.innerHTML = `<span>${PARTY_LABELS[p]||p}: ${s}</span>`;
    else if (percent > 3) segment.innerHTML = `<span>${s}</span>`;
    segment.title = `${PARTY_LABELS[p]||p}: ${s} MV`;
    bar.appendChild(segment);
  });

  document.getElementById('overallSection').style.display = 'block';
  document.getElementById('totalSeatsLabel').innerText = `Toplam: ${globalSeats} MV`;
}

// ARŞİV GETİRME DÜZELTİLDİ
document.getElementById('btnFetch').onclick = async () => {
  const file = document.getElementById('serverFiles').value;
  if(!file) { alert("Lütfen arşivden bir dosya seçin."); return; }
  try {
    const response = await fetch(file);
    if(!response.ok) throw new Error("Dosya bulunamadı.");
    const txt = await response.text();
    renderDashboard(txt);
  } catch(e) { alert("Arşiv dosyası yüklenemedi: " + e.message); }
};

document.getElementById('citySearch').oninput = (e) => {
  const query = trLower(e.target.value);
  document.querySelectorAll('.card').forEach(card => {
    const cityName = trLower(card.querySelector('.city-name').innerText);
    card.style.display = cityName.includes(query) ? 'flex' : 'none';
  });
};

function openFullscreen(idx) {
  currentIdx = idx;
  document.getElementById('fsInner').innerHTML = svgs[idx];
  document.getElementById('fsOverlay').style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

function closeFullscreen() {
  document.getElementById('fsOverlay').style.display = 'none';
  document.body.style.overflow = '';
}

document.getElementById('closeBtn').onclick = closeFullscreen;
document.getElementById('navL').onclick = () => { if(currentIdx > 0) openFullscreen(currentIdx - 1); };
document.getElementById('navR').onclick = () => { if(currentIdx < svgs.length - 1) openFullscreen(currentIdx + 1); };

// KLAVYE KONTROLLERİ (Sağ, Sol, ESC)
document.addEventListener('keydown', (e) => {
  if (document.getElementById('fsOverlay').style.display === 'flex') {
    if (e.key === "ArrowRight") { if(currentIdx < svgs.length - 1) openFullscreen(currentIdx + 1); }
    else if (e.key === "ArrowLeft") { if(currentIdx > 0) openFullscreen(currentIdx - 1); }
    else if (e.key === "Escape") { closeFullscreen(); }
  }
});

function parseNumber(s){ return parseInt(String(s||'0').replace(/\./g,'').replace(/,/g,'').trim()) || 0; }

function parseResults(txt){
  const blocks = txt.split(/\n(?:-+\s*\n|\s*\n){1,}/).filter(Boolean);
  return blocks.map(b => {
    const lines = b.trim().split('\n').map(l=>l.trim());
    let m = lines[0].match(/^(.+?)\s*[-:(]\s*(\d+)/);
    const city = m ? m[1] : lines[0];
    const seats = m ? parseNumber(m[2]) : 1;
    const votes = {};
    lines.slice(1).forEach(l => {
      let vm = l.match(/^(.+?)[\s:–-]+([\d\.,]+)/);
      if(vm) votes[vm[1].trim()] = parseNumber(vm[2]);
    });
    return {city, seats, votes};
  });
}

function dhondt(votes, seats) {
  const table = [];
  Object.entries(votes).forEach(([p,v]) => { for(let i=1; i<=seats; i++) table.push({p, q:v/i}); });
  table.sort((a,b) => b.q - a.q);
  const res = {};
  table.slice(0,seats).forEach(x => res[x.p] = (res[x.p]||0) + 1);
  return res;
}

async function buildSVG(obj){
  const W=1365, H=768;
  const total = Object.values(obj.votes).reduce((a,b)=>a+b,0)||1;
  const items = Object.entries(obj.votes).sort((a,b)=>b[1]-a[1]).slice(0,9);
  const alloc = dhondt(obj.votes, obj.seats);
  let s = `<svg width="${W}" height="${H}" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg" style="background:#fff">`;
  s += `<text x="40" y="80" font-family="ProductSans" font-size="60" font-weight="bold" fill="#111">${obj.city}</text>`;
  items.forEach(([p,v], i) => {
    const y = 160 + i*65;
    const w = (v/total) * 800;
    const color = (PARTY_COLORS[p] || PARTY_COLORS.DEFAULT).base;
    s += `<text x="320" y="${y+30}" font-family="ProductSans" font-size="28" text-anchor="end" fill="#444">${PARTY_LABELS[p]||p}</text>`;
    s += `<rect x="340" y="${y}" width="${w}" height="45" rx="8" fill="${color}" />`;
    s += `<text x="${350+w}" y="${y+30}" font-family="ProductSans" font-size="24" font-weight="bold" fill="#111">%${(v/total*100).toFixed(2)}</text>`;
    s += `<text x="1250" y="${y+35}" font-family="ProductSans" font-size="45" font-weight="bold" text-anchor="end">${alloc[p]||0}</text>`;
  });
  return s + `</svg>`;
}

document.getElementById('btnGen').onclick = async () => {
  const f = document.getElementById('fileTxt').files[0];
  if(f) renderDashboard(await f.text());
};
</script>
</body>
</html>